<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UniGlobe - Community Forum</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap');
    body { font-family: 'Poppins', sans-serif; }

    /* Gradient header/logo */
    .site-logo {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .nav-btn {
      position: relative;
      transition: color 0.3s ease;
    }
    .nav-btn::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: -4px;
      width: 0;
      height: 3px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      border-radius: 2px;
    }
    .nav-btn:hover::after {
      width: 100%;
    }
    .nav-btn:hover {
      color: #4f46e5;
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Navigation -->
  <nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <h1 class="site-logo">UniGlobe</h1>
        </div>
        <div class="hidden md:flex items-center space-x-8">
          <a href="home.html" class="nav-btn text-gray-700 font-medium">Home</a>
          <a href="community.html" class="nav-btn text-gray-700 font-medium">Community</a>
          <a href="chatbot.html" class="nav-btn text-gray-700 font-medium">AI Assistant</a>
          <a href="resources.html" class="nav-btn text-gray-700 font-medium">Resources</a>
          
          <!-- Notifications -->
          <button class="relative" onclick="toggleNotifications()">
            <span class="material-icons text-gray-600">notifications</span>
            <span class="absolute top-0 right-0 bg-red-500 text-white text-xs px-1 rounded-full">3</span>
          </button>
  
          <!-- Logout -->
          <button onclick="logout()" title="Logout">
            <span class="material-icons text-gray-600">logout</span>
          </button>
        </div>
      </div>
    </div>
  </nav>
  

  <!-- Community Section -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-3xl font-bold text-gray-900">Community Forum</h2>
      <button onclick="showNewPostModal()" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity">+ New Post</button>
    </div>

    <div class="grid lg:grid-cols-4 gap-7">
      <!-- Categories -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="font-semibold mb-4">Categories</h3>
          <div class="space-y-2">
            <button onclick="filterPosts('all',event)" class="category-btn w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">All Posts</button>
            <button onclick="filterPosts('housing',event)" class="category-btn w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">üè† Housing</button>
            <button onclick="filterPosts('visa',event)" class="category-btn w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">üìã Visa & Legal</button>
            <button onclick="filterPosts('social',event)" class="category-btn w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">üéâ Social & Events</button>
            <button onclick="filterPosts('academic',event)" class="category-btn w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">üìñ Academic</button>
            <button onclick="filterPosts('general',event)" class="category-btn w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">üí¨ General</button>
            
            <!-- My Posts (only visible when logged in) -->
            <div id="my-posts-btn" class="hidden">
              <button onclick="filterPosts('my')" class="category-btn w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors">üìù My Posts</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Posts -->
      <div class="lg:col-span-3">
        <div id="posts-container" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <!-- New Post Modal -->
  <div id="new-post-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-xl font-semibold mb-4">Create New Post</h3>
      <form onsubmit="createPost(event)">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
          <select id="post-category" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="general">General</option>
            <option value="housing">Housing</option>
            <option value="visa">Visa & Legal</option>
            <option value="social">Social & Events</option>
            <option value="academic">Academic</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
          <input type="text" id="post-title" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
          <textarea id="post-content" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required></textarea>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="hideNewPostModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button>
          <button type="submit" class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity">Post</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Notification Popup -->
  <div id="notification-popup" class="hidden fixed top-16 right-6 bg-white shadow-lg rounded-lg p-4 w-72 border border-gray-200 z-50">
    <h4 class="font-semibold text-gray-800 mb-2">Notifications</h4>
    <ul class="text-sm text-gray-600 space-y-2">
      <li>‚úÖ Your post has a new reply</li>
      <li>üìå New resource added: Housing Guide</li>
    </ul>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js">
  const supabase = supabase.createClient(
  "https://bshfxwbxtitdpxdvtguz.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJzaGZ4d2J4dGl0ZHB4ZHZ0Z3V6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MjEwOTIsImV4cCI6MjA3MzE5NzA5Mn0.4oJ-K75YuRTsp9PZE5V-zq49NNBD0p-zygP-8QVan84"
);
</script>
  

<script>
  // --- Application State ---
  let currentUser = null;
  let allPosts = [];
  let currentFilter = 'all';

  // --- Mock Data (since backend APIs don't exist) ---
  const mockPosts = [
    {
      id: 1,
      title: "Looking for roommate in downtown area",
      content: "Hi everyone! I'm searching for a roommate to share a 2BR apartment near the university. Clean, quiet, and responsible person preferred.",
      category: "housing",
      author: "john.doe@email.com",
      created_at: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
      replies: [
        { author: "jane.smith@email.com", text: "I might be interested! Can you share more details?" }
      ]
    },
    {
      id: 2,
      title: "Student visa extension process",
      content: "Has anyone recently gone through the visa extension process? Looking for tips and timeline expectations.",
      category: "visa",
      author: "student123@email.com",
      created_at: new Date(Date.now() - 172800000).toISOString(), // 2 days ago
      replies: []
    },
    {
      id: 3,
      title: "Weekend hiking group",
      content: "Starting a weekend hiking group for international students. All skill levels welcome!",
      category: "social",
      author: "outdoorlover@email.com",
      created_at: new Date(Date.now() - 259200000).toISOString(), // 3 days ago
      replies: [
        { author: "hiker99@email.com", text: "Count me in! What time do you usually start?" },
        { author: "naturefan@email.com", text: "This sounds great! I'm new to the area." }
      ]
    }
  ];

  // --- Initialization ---
  document.addEventListener("DOMContentLoaded", async () => {
    // Simulate authentication check
    try {
      // In a real app, this would check with your backend/Supabase
      currentUser = {
        email: "demo@uniglobe.com",
        id: "demo-user"
      };
      
      console.log("Logged in as:", currentUser.email);
      
      // Show "My Posts" button
      document.getElementById("my-posts-btn").classList.remove("hidden");
      
      // Load initial posts
      loadPosts();
      
    } catch (error) {
      console.error("Authentication error:", error);
      // In a real app, redirect to login
      // window.location.href = "index.html";
    }
  });

  // --- Post Management ---
  function loadPosts(filter = 'all') {
    try {
      currentFilter = filter;
      let filteredPosts = [...mockPosts, ...allPosts];
      
      // Apply filter
      switch (filter) {
        case 'my':
          filteredPosts = filteredPosts.filter(post => post.author === currentUser?.email);
          break;
        case 'all':
          // Show all posts
          break;
        default:
          filteredPosts = filteredPosts.filter(post => post.category === filter);
      }
      
      // Sort by creation date (newest first)
      filteredPosts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      
      renderPosts(filteredPosts);
      
    } catch (error) {
      console.error("Error loading posts:", error);
      showError("Failed to load posts");
    }
  }

  function renderPosts(posts) {
    const container = document.getElementById("posts-container");
    
    if (posts.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8">
          <p class="text-gray-500 italic text-lg">No posts found for this category.</p>
          <p class="text-gray-400 text-sm mt-2">Be the first to start a conversation!</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = posts.map(renderPost).join("");
  }

  function renderPost(post) {
    const categoryEmoji = {
      'housing': 'üè†',
      'visa': 'üìã',
      'social': 'üéâ',
      'academic': 'üìñ',
      'general': 'üí¨'
    };
    
    return `
      <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
        <div class="flex justify-between items-center mb-3">
          <span class="text-sm bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full font-medium">
            ${categoryEmoji[post.category] || 'üí¨'} ${post.category.charAt(0).toUpperCase() + post.category.slice(1)}
          </span>
          <span class="text-sm text-gray-500">${formatDate(post.created_at)}</span>
        </div>
        
        <h3 class="text-lg font-semibold mb-2 text-gray-900">${escapeHtml(post.title)}</h3>
        <p class="text-gray-600 mb-4 leading-relaxed">${escapeHtml(post.content)}</p>
        
        <div class="flex justify-between items-center mb-4">
          <span class="text-sm text-gray-500">By: ${post.author}</span>
          <span class="text-sm text-gray-400">${post.replies?.length || 0} replies</span>
        </div>

        <!-- Replies Section -->
        <div class="space-y-2 mb-4">
          ${(post.replies || []).map(reply => `
            <div class="bg-gray-50 border-l-4 border-indigo-500 p-3 rounded-r-lg">
              <div class="flex justify-between items-start">
                <span class="font-semibold text-indigo-700 text-sm">${reply.author}</span>
                <span class="text-xs text-gray-400">${reply.timestamp || 'just now'}</span>
              </div>
              <p class="text-gray-700 mt-1">${escapeHtml(reply.text)}</p>
            </div>
          `).join('')}
        </div>

        <!-- Reply Form -->
        <form onsubmit="addReply(event, ${post.id})" class="flex space-x-2">
          <input 
            type="text" 
            id="reply-input-${post.id}" 
            placeholder="Write a reply..." 
            class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            required
          >
          <button 
            type="submit" 
            class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-opacity"
          >
            Reply
          </button>
        </form>
      </div>
    `;
  }

  // --- Create New Post ---
  async function createPost(event) {
    event.preventDefault();
    
    if (!currentUser) {
      showError("You must be logged in to create a post");
      return;
    }
    
    const category = document.getElementById("post-category").value;
    const title = document.getElementById("post-title").value.trim();
    const content = document.getElementById("post-content").value.trim();
    
    if (!title || !content) {
      showError("Title and content are required");
      return;
    }
    
    try {
      // Create new post object
      const newPost = {
        id: Date.now(), // Simple ID generation
        title,
        content,
        category,
        author: currentUser.email,
        created_at: new Date().toISOString(),
        replies: []
      };
      
      // Add to posts array
      allPosts.unshift(newPost); // Add to beginning
      
      // Clear form and close modal
      document.getElementById("post-title").value = "";
      document.getElementById("post-content").value = "";
      document.getElementById("post-category").value = "general";
      hideNewPostModal();
      
      // Reload posts with current filter
      loadPosts(currentFilter);
      
      showSuccess("Post created successfully!");
      
    } catch (error) {
      console.error("Error creating post:", error);
      showError("Failed to create post. Please try again.");
    }
  }

  // --- Add Reply ---
  async function addReply(event, postId) {
    event.preventDefault();
    
    if (!currentUser) {
      showError("You must be logged in to reply");
      return;
    }
    
    const input = document.getElementById(`reply-input-${postId}`);
    const text = input.value.trim();
    
    if (!text) return;
    
    try {
      // Find the post and add reply
      const postIndex = allPosts.findIndex(p => p.id === postId);
      let targetPost = null;
      
      if (postIndex !== -1) {
        targetPost = allPosts[postIndex];
      } else {
        // Check mock posts
        targetPost = mockPosts.find(p => p.id === postId);
      }
      
      if (targetPost) {
        const newReply = {
          author: currentUser.email,
          text,
          timestamp: new Date().toLocaleTimeString()
        };
        
        if (!targetPost.replies) {
          targetPost.replies = [];
        }
        
        targetPost.replies.push(newReply);
        input.value = "";
        loadPosts(currentFilter);
        showSuccess("Reply added!");
      }
      
    } catch (error) {
      console.error("Error adding reply:", error);
      showError("Failed to add reply. Please try again.");
    }
  }

  // --- Filter Functions ---
  function filterPosts(category,event) {
    // Update active button state
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.classList.remove('bg-indigo-100', 'text-indigo-800');
    });
    
    event.target.classList.add('bg-indigo-100', 'text-indigo-800');
    
    loadPosts(category);
  }

  // --- Modal Functions ---
  function showNewPostModal() {
    const modal = document.getElementById("new-post-modal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");
    
    // Focus on title input
    setTimeout(() => {
      document.getElementById("post-title").focus();
    }, 100);
  }

  function hideNewPostModal() {
    const modal = document.getElementById("new-post-modal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  // --- Utility Functions ---
  function toggleNotifications() {
    const popup = document.getElementById("notification-popup");
    popup.classList.toggle("hidden");
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) return "1 day ago";
    if (diffDays < 7) return `${diffDays} days ago`;
    
    return date.toLocaleDateString();
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showError(message) {
    // Simple error notification
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
      errorDiv.remove();
    }, 3000);
  }

  function showSuccess(message) {
    // Simple success notification
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    successDiv.textContent = message;
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
      successDiv.remove();
    }, 3000);
  }

  function showLoading(show) {
    const container = document.getElementById("posts-container");
    if (show) {
      container.innerHTML = `
        <div class="flex justify-center items-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
          <span class="ml-2 text-gray-600">Loading...</span>
        </div>
      `;
    }
  }

  // --- Logout Function ---
  async function logout() {
    try {
      await supabase.auth.signOut();
      currentUser = null;
      console.log("Logged out");
      // window.location.href = "index.html";
      showSuccess("Logged out successfully!");
    } catch (error) {
      console.error("Logout error:", error);
      showError("Logout failed. Please try again.");
    }
  }


  // --- Close modals when clicking outside ---
  document.addEventListener('click', (event) => {
    const modal = document.getElementById('new-post-modal');
    const notification = document.getElementById('notification-popup');
    
    if (event.target === modal) {
      hideNewPostModal();
    }
    
    if (!event.target.closest('#notification-popup') && !event.target.closest('button[onclick="toggleNotifications()"]')) {
      notification.classList.add('hidden');
    }
  });
</script>

</body>
</html>
